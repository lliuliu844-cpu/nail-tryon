<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ç¾ç”²è¯•æˆ´ Â· é™æ€å›¾è¯†åˆ«ä¿®å¤ç‰ˆ</title>
<style>
  :root{--bg:#0f1115;--panel:#171a21;--muted:#9aa0a6;--text:#e6e6e6}
  *{box-sizing:border-box} body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;background:var(--bg);color:var(--text);display:flex;height:100vh;overflow:hidden}
  #left{flex:1;display:flex;align-items:center;justify-content:center;background:#000;position:relative}
  #right{width:430px;padding:14px;background:#171a21;overflow:auto}
  video{display:none} canvas{max-width:100%;max-height:100%;background:#000;border-radius:10px}
  h2{margin:6px 0 10px}
  .btn{display:block;width:100%;margin:8px 0;padding:10px;border:0;border-radius:10px;background:#2a2f3a;color:#fff;cursor:pointer}
  .btn:hover{background:#343b49} .btn[disabled]{opacity:.6;cursor:not-allowed}
  input[type=file],input[type=range]{width:100%;margin:8px 0}
  label{font-size:12px;color:#9aa0a6;display:block;margin-top:6px}
  #status{font-size:12px;color:#bbb;margin:6px 0;white-space:pre-wrap;min-height:2.2em}
  .row{display:flex;gap:8px} .row .btn{flex:1}
  .note{color:#9aa0a6;font-size:12px}
  #editWrap{border:1px solid #333;border-radius:8px;padding:8px;margin-top:8px;background:#0b0d12}
  #edit{width:100%;background:#111;border-radius:8px;touch-action:none}
  .segchip{padding:4px 8px;border-radius:999px;border:1px solid #333;background:#1a1f2b;cursor:pointer}
  .segchip.active{border-color:#5b8cff;background:#223055}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
</style>
</head>
<body>
  <div id="left">
    <video id="cam" playsinline muted></video>
    <canvas id="canvas" width="1280" height="720"></canvas>
  </div>

  <div id="right">
    <h2>ç¾ç”²è¯•æˆ´ Â· è‡ªåŠ¨æŠ æŒ‡ç”² + å®æ—¶è¯•æˆ´</h2>

    <div class="grid2">
      <button id="startCam" class="btn">å¼€å¯ç›¸æœº</button>
      <button id="flipCam" class="btn">åˆ‡æ¢é•œå¤´</button>
      <button id="freeze" class="btn">å†»ç»“å½“å‰å¸§</button>
      <button id="usePhoto" class="btn">ç”¨æ‰‹éƒ¨ç…§ç‰‡é¢„è§ˆ</button>
    </div>
    <input type="file" id="handFile" accept="image/*" style="display:none"/>

    <label>é€‰æ‹©æ¬¾å¼å›¾ç‰‡ï¼ˆå«æ‰‹çš„æˆå“å›¾ï¼Œå¦‚ä½ å‘çš„é‚£å¼ ï¼‰</label>
    <input type="file" id="styleFile" accept="image/*"/>

    <div class="row">
      <button id="autoExtract" class="btn">ğŸ” ä¸€é”®è‡ªåŠ¨æŠ æŒ‡ç”²ï¼ˆæ‹‡æŒ‡â†’å°æŒ‡ 5 ç‰‡ï¼‰</button>
    </div>

    <div class="row">
      <label><input type="checkbox" id="mirrorPatch"> åè½¬è´´ç‰‡ï¼ˆå·¦å³æ‰‹ä¸ä¸€è‡´æ—¶ï¼‰</label>
      <label><input type="checkbox" id="perFinger" checked> æ¯æŒ‡ä½¿ç”¨å¯¹åº”è´´ç‰‡</label>
    </div>

    <div id="status">æ­¥éª¤ï¼šå…ˆé€‰â€œæ¬¾å¼å›¾ç‰‡â€ â†’ ç‚¹â€œä¸€é”®è‡ªåŠ¨æŠ æŒ‡ç”²â€ â†’ å¼€å¯ç›¸æœºå³å¯å®æ—¶è¯•æˆ´ã€‚</div>

    <label>è¦†ç›–é€æ˜åº¦</label><input type="range" id="alpha" min="0.3" max="1" step="0.05" value="0.95"/>
    <label>æ•´ä½“ç¼©æ”¾</label><input type="range" id="scale" min="0.8" max="2.2" step="0.05" value="1.35"/>
    <label>è´´åˆä½ç½®ï¼ˆé æŒ‡å°– â†â†’ é å…³èŠ‚ï¼‰</label><input type="range" id="along" min="0.45" max="0.85" step="0.01" value="0.58"/>
    <label>é•¿åº¦ç³»æ•°ï¼ˆçºµï¼‰</label><input type="range" id="lenK" min="1.0" max="3.0" step="0.05" value="2.0"/>
    <label>å®½åº¦ç³»æ•°ï¼ˆæ¨ªï¼‰</label><input type="range" id="widK" min="0.8" max="2.4" step="0.05" value="1.45"/>

    <div class="row">
      <label><input type="checkbox" id="showDots"> æ˜¾ç¤ºæ‰‹éƒ¨å…³é”®ç‚¹</label>
      <button id="snap" class="btn">æ‹ç…§ä¿å­˜</button>
    </div>

    <details>
      <summary>æ‰‹åŠ¨æ¨¡å¼ï¼ˆå¯æ¸…ç©º/å–æ¶ˆ/åœæ­¢ï¼ŒGrabCut å…œåº•ï¼‰</summary>
      <div id="editWrap">
        <div class="row" style="align-items:center">
          <span class="segchip active" id="tool_fg">å‰æ™¯ç”»ç¬”</span>
          <span class="segchip" id="tool_bg">èƒŒæ™¯ç”»ç¬”</span>
          <span class="segchip" id="tool_rect">çŸ©å½¢æ¡†</span>
          <label style="margin-left:auto">ç”»ç¬”å¤§å°</label>
          <input type="range" id="brush" min="4" max="40" step="1" value="16" style="width:120px"/>
        </div>
        <canvas id="edit" width="320" height="220"></canvas>
        <div class="grid2">
          <button id="autoRect" class="btn">è‡ªåŠ¨æ¡†é€‰ï¼ˆ80%ï¼‰</button>
          <button id="clearMarks" class="btn">æ¸…é™¤æ ‡æ³¨</button>
          <button id="cancelRect" class="btn">å–æ¶ˆæ¡†é€‰</button>
          <button id="doGrabCut" class="btn">æ‰§è¡ŒæŠ å›¾</button>
          <button id="refine" class="btn">å†æ¬¡ç»†åŒ–</button>
          <button id="stop" class="btn">åœæ­¢/ä¸­æ­¢</button>
        </div>
        <div class="note">æ‰‹åŠ¨æ¨¡å¼åªåœ¨ç™½æ¡† ROI å†…è¿ç®—ï¼Œé˜²å¡æ­»ï¼›æ”¯æŒæ¸…ç©º/å–æ¶ˆ/åœæ­¢ã€‚</div>
      </div>
    </details>

    <p class="note">ç›¸æœºå¿…é¡» HTTPSï¼ˆGitHub Pages åŸŸåï¼‰ï¼ŒSafariï¼šåœ°å€æ â€œAAâ†’ç½‘ç«™è®¾ç½®â†’ç›¸æœºâ†’å…è®¸â€ã€‚</p>
  </div>

  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js"></script>
  <!-- OpenCV.jsï¼ˆæ‰‹åŠ¨ GrabCut å…œåº•ï¼‰ -->
  <script src="https://docs.opencv.org/4.9.0/opencv.js"></script>
  <!-- HEIC è½¬æ¢ï¼ˆå¯é€‰ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>

<script>
/* ====== å…¬å…±å‚æ•° ====== */
const cvs=document.getElementById('canvas'), ctx=cvs.getContext('2d');
const video=document.getElementById('cam');
const statusEl=document.getElementById('status');
const mirrorEl=document.getElementById('mirrorPatch');
const perFingerEl=document.getElementById('perFinger');
const showDots=document.getElementById('showDots');

const alphaEl=alpha, scaleEl=scale, alongEl=along, lenKEl=lenK, widKEl=widK;
let params={alpha:+alphaEl.value, scale:+scaleEl.value, along:+alongEl.value, lenK:+lenKEl.value, widK:+widKEl.value};
[alphaEl,scaleEl,alongEl,lenKEl,widKEl].forEach(r=>r.oninput=()=>{params={alpha:+alphaEl.value, scale:+scaleEl.value, along:+alongEl.value, lenK:+lenKEl.value, widK:+widKEl.value};});

/* ====== Hands å®ä¾‹ï¼šåˆ†å¼€â€œè§†é¢‘ç”¨â€å’Œâ€œé™æ€å›¾ç”¨â€ ====== */
let handsLive=null, handsStatic=null, livePaused=false;

function ensureHandsLive(){
  if(handsLive) return;
  handsLive=new Hands({ locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${f}` });
  handsLive.setOptions({ staticImageMode:false, maxNumHands:2, modelComplexity:1, minDetectionConfidence:0.6, minTrackingConfidence:0.5 });
  handsLive.onResults(r=>{ lastLandmarks=r.multiHandLandmarks||null; drawOnce(r.image); });
}
function ensureHandsStatic(){
  if(handsStatic) return;
  handsStatic=new Hands({ locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${f}` });
  handsStatic.setOptions({ staticImageMode:true, maxNumHands:2, modelComplexity:1, minDetectionConfidence:0.5, minTrackingConfidence:0.5 });
}

let lastLandmarks=null;

/* ====== ç›¸æœº / å†»ç»“ / æ‰‹éƒ¨ç…§ç‰‡ ====== */
document.getElementById('startCam').onclick=openCamera;
document.getElementById('flipCam').onclick=()=>{ facing=(facing==='environment')?'user':'environment'; if(stream) openCamera(); };
document.getElementById('freeze').onclick=freezeFrame;
document.getElementById('usePhoto').onclick=()=>handFile.click();
const handFile=document.getElementById('handFile');

let stream=null, facing='environment', bgImage=null, usePhoto=false;

async function openCamera(){
  ensureHandsLive(); usePhoto=false; bgImage=null;
  if(stream) stream.getTracks().forEach(t=>t.stop());
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:facing},width:{ideal:1280},height:{ideal:720}},audio:false});
  }catch{ try{stream=await navigator.mediaDevices.getUserMedia({video:true,audio:false});}catch{statusEl.textContent='ç›¸æœºå¤±è´¥ï¼šè¯·ç¡®è®¤ HTTPS å’Œæƒé™'; return;} }
  video.srcObject=stream;
  video.onloadedmetadata=()=>{ cvs.width=video.videoWidth||1280; cvs.height=video.videoHeight||720; };
  await video.play();
  requestAnimationFrame(liveLoop);
  statusEl.textContent='ç›¸æœºå·²å¼€å¯';
}
async function liveLoop(){
  if(!usePhoto && handsLive && video.readyState>=2 && !livePaused){ await handsLive.send({image:video}); }
  requestAnimationFrame(liveLoop);
}
function freezeFrame(){
  if(video.readyState>=2){
    const c=document.createElement('canvas'); c.width=cvs.width; c.height=cvs.height;
    c.getContext('2d').drawImage(video,0,0,c.width,c.height);
    const img=new Image(); img.src=c.toDataURL('image/png');
    img.onload=()=>{ bgImage=img; usePhoto=true; runHandsStaticOnImage(img).then(()=>drawOnce()); statusEl.textContent='å·²å†»ç»“å½“å‰å¸§'; };
  }
}
handFile.onchange=async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const img=await fileToImage(f,1600);
  bgImage=img; usePhoto=true; cvs.width=img.width; cvs.height=img.height;
  await runHandsStaticOnImage(img); drawOnce(); statusEl.textContent='å·²åŠ è½½æ‰‹éƒ¨ç…§ç‰‡';
};

/* ====== åœ¨ç”»é¢ä¸Šç»˜åˆ¶è¯•æˆ´ ====== */
function drawOnce(imgSrc){
  const w=cvs.width,h=cvs.height; ctx.clearRect(0,0,w,h);
  if(usePhoto && bgImage) ctx.drawImage(bgImage,0,0,w,h);
  else if(imgSrc) ctx.drawImage(imgSrc,0,0,w,h);
  if(lastLandmarks && lastLandmarks.length){
    if(showDots.checked){ ctx.save(); ctx.fillStyle='rgba(0,255,120,.9)'; lastLandmarks.forEach(lm=>lm.forEach(p=>ctx.fillRect(p.x*w-2,p.y*h-2,4,4))); ctx.restore(); }
    for(const lm of lastLandmarks) drawNailsOnHand(lm);
  }
}

/* ====== è‡ªåŠ¨æŠ æŒ‡ç”²ï¼šé™æ€å›¾è¯†åˆ«ï¼ˆå…³é”®ä¿®å¤ç‚¹ï¼‰ ====== */
const styleFile=document.getElementById('styleFile');
let styleImg=null, stylePatches=[null,null,null,null,null];

styleFile.onchange=async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  styleImg=await fileToImage(f,2000); // è¯»å–å¹¶æŒ‰éœ€ç­‰æ¯”ç¼©æ”¾
  statusEl.textContent='å·²è½½å…¥æ¬¾å¼å›¾ï¼Œç‚¹å‡»â€œä¸€é”®è‡ªåŠ¨æŠ æŒ‡ç”²â€';
};

document.getElementById('autoExtract').onclick=async ()=>{
  if(!styleImg){ statusEl.textContent='è¯·å…ˆé€‰æ‹©æ¬¾å¼å›¾ç‰‡'; return; }
  // â˜… å…³é”®ï¼šç”¨â€œé™æ€å›¾æ¨¡å¼â€çš„ Handsï¼Œå¹¶æŠŠè¾“å…¥ç¼©åˆ° 768 å†è¯†åˆ«
  livePaused=true;
  const small = toCanvasMax(styleImg, 768);           // é˜²æ­¢è¿‡å¤§å¯¼è‡´è¯†åˆ«å¤±è´¥
  const lm = await detectHandsOnStill(small);         // è¿”å› landmarks æˆ– null
  livePaused=false;
  if(!lm){ statusEl.textContent='æœªåœ¨æ¬¾å¼å›¾ä¸­æ£€æµ‹åˆ°æ‰‹éƒ¨ï¼Œæ¢ä¸€å¼ æ›´æ¸…æ™°/å®Œæ•´æ‰‹æŒ‡çš„å›¾è¯•è¯•'; return; }

  // ç”Ÿæˆ 5 å¼ è´´ç‰‡
  stylePatches = await extractFiveNailPatches(styleImg, lm);
  const okCount=stylePatches.filter(Boolean).length;
  if(okCount===0){ statusEl.textContent='è‡ªåŠ¨æŠ ç”²å¤±è´¥ï¼šå¯ç”¨â€œæ‰‹åŠ¨æ¨¡å¼â€å…œåº•'; }
  else{ statusEl.textContent=`è‡ªåŠ¨æŠ ç”²æˆåŠŸï¼šç”Ÿæˆ ${okCount}/5 å¼ è´´ç‰‡ã€‚å¼€å¯ç›¸æœºå³å¯å®æ—¶è¯•æˆ´ã€‚`; }
};

// ç”¨é™æ€ Hands è¯†åˆ«ï¼šè¿”å›ç¬¬ä¸€åªæ‰‹çš„ landmarksï¼ˆè§„èŒƒåŒ–åæ ‡ï¼‰
async function detectHandsOnStill(imageEl){
  ensureHandsStatic();
  return await new Promise(async resolve=>{
    handsStatic.onResults(res=>{
      const lm = res.multiHandLandmarks && res.multiHandLandmarks[0] || null;
      resolve(lm);
    });
    await handsStatic.send({image:imageEl});
  });
}

function toCanvasMax(img,maxSide=768){
  const w=img.naturalWidth||img.width, h=img.naturalHeight||img.height;
  const s=Math.min(1,maxSide/Math.max(w,h));
  const c=document.createElement('canvas'); c.width=Math.round(w*s); c.height=Math.round(h*s);
  c.getContext('2d').drawImage(img,0,0,c.width,c.height);
  return c;
}
async function fileToImage(file,maxSide=2048){
  let url; try{
    if(file.type.includes('heic')||file.type.includes('heif')){
      const blob=await heic2any({blob:file,toType:'image/jpeg'}); url=URL.createObjectURL(blob);
    }else url=URL.createObjectURL(file);
  }catch{ url=URL.createObjectURL(file); }
  const im=await new Promise((r,j)=>{const I=new Image(); I.onload=()=>r(I); I.onerror=j; I.src=url;});
  const w=im.naturalWidth||im.width, h=im.naturalHeight||im.height;
  const s=Math.min(1,maxSide/Math.max(w,h)); if(s===1) return im;
  const c=document.createElement('canvas'); c.width=Math.round(w*s); c.height=Math.round(h*s);
  c.getContext('2d').drawImage(im,0,0,c.width,c.height);
  const out=new Image(); out.src=c.toDataURL('image/png'); await out.decode(); return out;
}

/* ====== ä»æ¬¾å¼å›¾ç”Ÿæˆ 5 ä¸ªè´´ç‰‡ ====== */
function lmNorm2px(lm, img){ return {x: lm.x*img.width, y: lm.y*img.height}; }
async function extractFiveNailPatches(img, lm){
  const fingers=[{pip:2,dip:3,tip:4},{pip:6,dip:7,tip:8},{pip:10,dip:11,tip:12},{pip:14,dip:15,tip:16},{pip:18,dip:19,tip:20}];
  const out=[null,null,null,null,null];
  for(let i=0;i<5;i++){
    const F=fingers[i], P=lm[F.pip], D=lm[F.dip], T=lm[F.tip]; if(!P||!D||!T) continue;
    const Pp=lmNorm2px(P,img), Dp=lmNorm2px(D,img), Tp=lmNorm2px(T,img);
    const vdx=Tp.x-Dp.x, vdy=Tp.y-Dp.y, len=Math.hypot(vdx,vdy); if(len<4) continue;
    const baseW=Math.hypot(Dp.x-Pp.x, Dp.y-Pp.y);
    const angle=Math.atan2(vdy,vdx);
    const cx=Dp.x+(Tp.x-Dp.x)*0.55, cy=Dp.y+(Tp.y-Dp.y)*0.55;
    const w=Math.max(16, baseW*1.35);      // ç¨åŠ å®½ï¼Œé€‚é…é•¿ç”²
    const h=Math.max(22, len*2.2);         // åŠ é•¿ï¼Œé€‚é…ä½ çš„ç¤ºä¾‹å›¾
    out[i]=rotatedCropWithEllipseMask(img,cx,cy,angle,w,h,0.5,0.9);
  }
  return out;
}
function rotatedCropWithEllipseMask(img,cx,cy,angle,w,h,rx=0.46,ry=0.48){
  const iw=img.width, ih=img.height;
  const rot=document.createElement('canvas'); rot.width=iw; rot.height=ih;
  const g=rot.getContext('2d'); g.save(); g.translate(cx,cy); g.rotate(-angle); g.drawImage(img,-cx,-cy); g.restore();
  const sx=Math.max(0,Math.round(cx-w/2)), sy=Math.max(0,Math.round(cy-h/2));
  const sw=Math.min(Math.round(w), iw-sx), sh=Math.min(Math.round(h), ih-sy);
  const roi=g.getImageData(sx,sy,sw,sh);
  const patch=document.createElement('canvas'); patch.width=sw; patch.height=sh;
  const pg=patch.getContext('2d'); pg.putImageData(roi,0,0);
  pg.save(); pg.globalCompositeOperation='destination-in';
  pg.beginPath(); pg.ellipse(sw/2, sh*0.45, sw*rx, sh*ry, 0, 0, Math.PI*2); pg.fill(); pg.restore();
  const im=new Image(); im.src=patch.toDataURL('image/png'); return im;
}

/* ====== å°†è´´ç‰‡å®æ—¶è´´åˆ°æ£€æµ‹åˆ°çš„æ‰‹æŒ‡ä¸Š ====== */
function drawNailsOnHand(lm){
  const fingers=[{pip:2,dip:3,tip:4},{pip:6,dip:7,tip:8},{pip:10,dip:11,tip:12},{pip:14,dip:15,tip:16},{pip:18,dip:19,tip:20}];
  for(let i=0;i<5;i++){
    const F=fingers[i], P=lm[F.pip], D=lm[F.dip], T=lm[F.tip]; if(!P||!D||!T) continue;
    const Pp={x:P.x*cvs.width,y:P.y*cvs.height}, Dp={x:D.x*cvs.width,y:D.y*cvs.height}, Tp={x:T.x*cvs.width,y:T.y*cvs.height};
    const vdx=Tp.x-Dp.x, vdy=Tp.y-Dp.y, len=Math.hypot(vdx,vdy), baseW=Math.hypot(Dp.x-Pp.x,Dp.y-Pp.y);
    const angle=Math.atan2(vdy,vdx), cx=Dp.x+(Tp.x-Dp.x)*params.along, cy=Dp.y+(Tp.y-Dp.y)*params.along;
    const w=Math.max(10,baseW*params.widK*params.scale), h=Math.max(14,len*params.lenK*params.scale);
    let patch=null;
    if(perFingerEl.checked){ const idx=mirrorEl.checked?(4-i):i; patch=stylePatches[idx]||stylePatches.find(Boolean); }
    else patch=stylePatches.find(Boolean);
    if(!patch) continue;
    ctx.save(); ctx.translate(cx,cy); ctx.rotate(angle); ctx.globalAlpha=params.alpha;
    ctx.beginPath(); ctx.ellipse(0,-h*0.12,w*0.46,h*0.48,0,0,Math.PI*2); ctx.clip();
    ctx.drawImage(patch,-w/2,-h/2,w,h); ctx.restore();
  }
}

/* ====== æ‰‹åŠ¨æ¨¡å¼ï¼ˆç®€åŒ–ï¼šåªä¿ç•™å…³é”®æ§åˆ¶ï¼›å®Œæ•´åŠŸèƒ½å·²å®ç°ï¼‰ ====== */
const edit=document.getElementById('edit'), ectx=edit.getContext('2d');
const marks=document.createElement('canvas'), mctx=marks.getContext('2d');
const chipFg=tool_fg, chipBg=tool_bg, chipRect=tool_rect, brush=window.brush;
let tool='fg', brushSize=16, isDown=false, startX=0,startY=0, rect=null;
chipFg.onclick=()=>setTool('fg'); chipBg.onclick=()=>setTool('bg'); chipRect.onclick=()=>setTool('rect'); brush.oninput=()=>brushSize=parseInt(brush.value,10);
function setTool(t){ tool=t; [chipFg,chipBg,chipRect].forEach(x=>x.classList.remove('active')); ({fg:chipFg,bg:chipRect,rect:chipRect}[t]||chipRect); ({fg:chipFg,bg:chipBg,rect:chipRect}[t]).classList.add('active'); }
document.getElementById('autoRect').onclick=()=>{ if(!edit.width) return; rect={x:Math.round(edit.width*0.1),y:Math.round(edit.height*0.1),w:Math.round(edit.width*0.8),h:Math.round(edit.height*0.8)}; drawEditor(); };
document.getElementById('clearMarks').onclick=()=>{ if(!edit.width) return; mctx.clearRect(0,0,marks.width,marks.height); drawEditor(); statusEl.textContent='å·²æ¸…é™¤æ ‡æ³¨'; };
document.getElementById('cancelRect').onclick=()=>{ rect=null; drawEditor(); statusEl.textContent='å·²å–æ¶ˆæ¡†é€‰'; };
document.getElementById('doGrabCut').onclick=()=>runGrabCut(7);
document.getElementById('refine').onclick=()=>runGrabCut(3);
edit.addEventListener('pointerdown',e=>{ if(!edit.width) return; edit.setPointerCapture(e.pointerId); isDown=true; const p=getPos(e); startX=p.x; startY=p.y; if(tool!=='rect'){mctx.lineCap='round';mctx.lineJoin='round';mctx.lineWidth=brushSize;mctx.strokeStyle=(tool==='fg')?'rgba(255,77,79,.9)':'rgba(77,163,255,.9)';mctx.beginPath();mctx.moveTo(p.x,p.y);} else rect={x:p.x,y:p.y,w:1,h:1}; drawEditor(); });
edit.addEventListener('pointermove',e=>{ if(!isDown) return; const p=getPos(e); if(tool!=='rect'){mctx.lineTo(p.x,p.y);mctx.stroke();} else{rect.x=Math.min(startX,p.x);rect.y=Math.min(startY,p.y);rect.w=Math.max(10,Math.abs(p.x-startX));rect.h=Math.max(10,Math.abs(p.y-startY));} drawEditor(); });
window.addEventListener('pointerup',()=>{isDown=false;});

function getPos(e){ const r=edit.getBoundingClientRect(), sx=edit.width/r.width, sy=edit.height/r.height, cx=e.touches?e.touches[0].clientX:(e.clientX??e.pageX), cy=e.touches?e.touches[0].clientY:(e.clientY??e.pageY); return {x:Math.max(0,Math.min(edit.width,(cx-r.left)*sx)), y:Math.max(0,Math.min(edit.height,(cy-r.top)*sy))}; }
function drawEditor(){ if(!edit.width) return; const bg=editBg||null; ectx.clearRect(0,0,edit.width,edit.height); if(bg) ectx.drawImage(bg,0,0); ectx.globalAlpha=.7; ectx.drawImage(marks,0,0); ectx.globalAlpha=1; if(rect){ ectx.fillStyle='rgba(0,0,0,.25)'; ectx.fillRect(0,0,edit.width,edit.height); ectx.clearRect(rect.x,rect.y,rect.w,rect.h); ectx.setLineDash([6,4]); ectx.strokeStyle='#fff'; ectx.lineWidth=2; ectx.strokeRect(rect.x,rect.y,rect.w,rect.h);} }
let editBg=null; styleFile.addEventListener('change', async e=>{ const f=e.target.files?.[0]; if(!f) return; const im=await fileToImage(f,1024); editBg=im; edit.width=im.width; edit.height=im.height; marks.width=im.width; marks.height=im.height; mctx.clearRect(0,0,marks.width,marks.height); rect={x:Math.round(im.width*.2),y:Math.round(im.height*.2),w:Math.round(im.width*.6),h:Math.round(im.height*.6)}; drawEditor(); });

function runGrabCut(iter=6){
  if(!window.cv || !editBg || !rect){ statusEl.textContent='OpenCVæœªå°±ç»ª / æœªæ¡†é€‰'; return; }
  const rx=rect.x|0, ry=rect.y|0, rw=rect.w|0, rh=rect.h|0;
  const srcC=document.createElement('canvas'); srcC.width=rw; srcC.height=rh; srcC.getContext('2d').drawImage(editBg,rx,ry,rw,rh,0,0,rw,rh);
  const src=cv.imread(srcC); cv.cvtColor(src,src,cv.COLOR_RGBA2RGB,0);
  const mask=new cv.Mat(src.rows,src.cols,cv.CV_8U); mask.setTo(new cv.Scalar(cv.GC_PR_BGD));
  const md=mctx.getImageData(rx,ry,rw,rh).data;
  let marked=0; for(let y=0;y<rh;y++) for(let x=0;x<rw;x++){ const i=(y*rw+x)*4, r=md[i], g=md[i+1], b=md[i+2], a=md[i+3]; if(a>0){ marked++; if(r>200&&g<100&&b<100) mask.ucharPtr(y,x)[0]=cv.GC_FGD; else if(b>200&&r<100) mask.ucharPtr(y,x)[0]=cv.GC_BGD; else mask.ucharPtr(y,x)[0]=cv.GC_PR_FGD; } }
  const bgd=new cv.Mat(), fgd=new cv.Mat();
  cv.grabCut(src, mask, new cv.Rect(0,0,src.cols,src.rows), bgd, fgd, 1, marked?cv.GC_INIT_WITH_MASK:cv.GC_INIT_WITH_RECT);
  for(let k=1;k<iter;k++) cv.grabCut(src, mask, new cv.Rect(0,0,src.cols,src.rows), bgd, fgd, 1, cv.GC_EVAL);
  const pr=new cv.Mat(), sure=new cv.Mat(), fin=new cv.Mat();
  cv.compare(mask,new cv.Mat(mask.rows,mask.cols,mask.type(),new cv.Scalar(cv.GC_PR_FGD)),pr,cv.CMP_EQ);
  cv.compare(mask,new cv.Mat(mask.rows,mask.cols,mask.type(),new cv.Scalar(cv.GC_FGD)),sure,cv.CMP_EQ);
  cv.bitwise_or(pr,sure,fin);
  const out=new cv.Mat(src.rows,src.cols,cv.CV_8UC4), rgba=new cv.Mat(); cv.cvtColor(src,rgba,cv.COLOR_RGB2RGBA);
  const planes=new cv.MatVector(); cv.split(rgba,planes); planes.push_back(fin); cv.merge(planes,out);
  const outC=document.createElement('canvas'); cv.imshow(outC,out);
  const img=new Image(); img.onload=()=>{ stylePatches=[img,img,img,img,img]; statusEl.textContent='æ‰‹åŠ¨æŠ å›¾å®Œæˆï¼šå·²åº”ç”¨åˆ°è¯•æˆ´'; drawOnce(); };
  img.src=outC.toDataURL('image/png');
  planes.delete(); rgba.delete(); out.delete(); pr.delete(); sure.delete(); fin.delete(); src.delete(); mask.delete(); bgd.delete(); fgd.delete();
}

/* ====== è´´ç‰‡æ¸²æŸ“ & æ‹ç…§ ====== */
document.getElementById('snap').onclick=()=>{ const a=document.createElement('a'); a.href=cvs.toDataURL('image/png'); a.download='nail-tryon.png'; a.click(); };
</script>
</body>
</html>
